import{_ as e,c as i,e as a,o as n}from"./app-BHJp8oNa.js";const l={};function t(d,s){return n(),i("div",null,s[0]||(s[0]=[a(`<h2 id="一、forever" tabindex="-1"><a class="header-anchor" href="#一、forever"><span>一、forever</span></a></h2><blockquote><p><code>forever</code>则可以在<code>cmd</code>或<code>ssh</code>连接断开时,让项目一直运行,而且可以在项目崩溃时自动重启</p></blockquote><ul><li>安装 <code>npm install -g forever</code></li><li><code>forever</code>的帮助手册 <code>forever --help</code></li><li>使用<code>forever</code>启动项目 <code>forever start app.js</code></li><li>使用<code>forever</code>停止项目 <code>forever stop app.js</code></li><li>列出所有通过<code>forever</code>管理的项目 <code>forever list</code></li><li>监视项目中的文件,当文件有变动时重启项目 <code>forever -w start app.js</code></li></ul><h2 id="二、pm2" tabindex="-1"><a class="header-anchor" href="#二、pm2"><span>二、pm2</span></a></h2><blockquote><p>部署参考 http://blog.poetries.top/2018/11/18/react-ssr-next-deploy/</p></blockquote><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-"><span class="line"><span>npm install pm2 -g</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>新建一份index.js测试，运行以下命令测试</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-"><span class="line"><span>pm2 start index.js</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><strong>运行</strong></p><blockquote><p>你可以执行以下命令来重启和暂停服务</p></blockquote><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-"><span class="line"><span>pm2 stop     &lt;app_name|id|&#39;all&#39;|json_conf&gt;</span></span>
<span class="line"><span>pm2 restart  &lt;app_name|id|&#39;all&#39;|json_conf&gt;</span></span>
<span class="line"><span>pm2 delete   &lt;app_name|id|&#39;all&#39;|json_conf&gt;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>比如<code>pm2 stop index.js</code>，暂停上面的<code>index.js</code>服务</p></blockquote><p><strong>常用命令</strong></p><ul><li>运行<code> pm2 start app.js</code></li><li>查看运行状态 <code>pm2 list</code></li><li>追踪资源运行情况 <code>pm2 monit</code></li><li>查看日志 <code>pm2 logs</code></li><li>重启应用 <code>pm2 restart appId</code></li><li>停止应用 <code>pm2 stop app.js</code></li><li>开启<code>api</code>访问 <code>pm2 web</code></li></ul><p><strong>自动重启</strong></p><p>当文件改动则自动重启服务</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-"><span class="line"><span>pm2 start app.js --watch</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>这里是监控整个项目的文件，如果只想监听指定文件和目录，建议通过下面配置文件的<code>watch</code>、<code>ignore_watch</code>字段来设置</p><p><strong>配置文件</strong></p><p>编写一份<code>ecosystem.json</code>文件，完整配置说明请参考官方文档</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-"><span class="line"><span>{</span></span>
<span class="line"><span>    &quot;name&quot;: &quot;test&quot;,</span><span> // 应用名称</span></span>
<span class="line"><span>    &quot;script&quot;: &quot;./bin/www&quot;,</span><span> // 实际启动脚本</span></span>
<span class="line"><span>    &quot;cwd&quot;: &quot;./&quot;,</span><span> // 当前工作路径</span></span>
<span class="line"><span>    &quot;watch&quot;: [</span><span> // 监控变化的目录，一旦变化，自动重启</span></span>
<span class="line"><span>        &quot;bin&quot;,</span></span>
<span class="line"><span>        &quot;routers&quot;</span></span>
<span class="line"><span>    ],</span></span>
<span class="line"><span>    &quot;ignore_watch&quot;: [</span><span> // 从监控目录中排除</span></span>
<span class="line"><span>        &quot;node_modules&quot;,</span></span>
<span class="line"><span>        &quot;logs&quot;,</span></span>
<span class="line"><span>        &quot;public&quot;</span></span>
<span class="line"><span>    ],</span></span>
<span class="line"><span>    &quot;watch_options&quot;: {</span></span>
<span class="line"><span>        &quot;followSymlinks&quot;: false</span></span>
<span class="line"><span>    },</span></span>
<span class="line"><span>    &quot;max_memory_restart&quot;: &quot;100M&quot;,</span><span> //超过最大内存重启</span></span>
<span class="line"><span>    &quot;error_file&quot;: &quot;./logs/app-err.log&quot;,</span><span> // 错误日志路径</span></span>
<span class="line"><span>    &quot;out_file&quot;: &quot;./logs/app-out.log&quot;,</span><span> // 普通日志路径</span></span>
<span class="line"><span>    &quot;env&quot;: {</span></span>
<span class="line"><span>        &quot;NODE_ENV&quot;: &quot;production&quot;</span><span> // 环境参数，当前指定为生产环境</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>配置完后你可以执行以下命令</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># Start all apps</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">pm2</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> start</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ecosystem.json</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># Stop</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">pm2</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> stop</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ecosystem.json</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># Restart</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">pm2</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> start</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ecosystem.json</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">## Or</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">pm2</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> restart</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ecosystem.json</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># Reload</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">pm2</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> reload</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ecosystem.json</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># Delete from PM2</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">pm2</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> delete</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ecosystem.json</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这里注意的是配置文件改变了之后要先<code>delete</code>再<code>start</code>配置文件才能生效</p><p><strong>负载均衡</strong></p><p>命令如下，表示开启三个进程。如果-i 0，则会根据机器当前核数自动开启尽可能多的进程</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-"><span class="line"><span>pm2 start app.js -i 3      //开启三个进程</span></span>
<span class="line"><span>pm2 start app.js -i max //根据机器CPU核数，开启对应数目的进程</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>日志查看</strong></p><p>除了可以打开日志文件查看日志外，还可以通过pm2 logs来查看实时日志。这点对于线上问题排查非常重要</p><p>比如某个node服务突然异常重启了，那么可以通过pm2提供的日志工具来查看实时日志，看是不是脚本出错之类导致的异常重启。</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-"><span class="line"><span>pm2 logs</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><strong>内存使用超过上限自动重启</strong></p><blockquote><p>如果想要你的应用，在超过使用内存上限后自动重启，那么可以加上<code>--max-memory-restart</code>参数。（有对应的配置项）</p></blockquote><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-"><span class="line"><span>pm2 start big-array.js --max-memory-restart 20M</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><strong>pm2与forever对比</strong></p><table><thead><tr><th>Feature</th><th>Forever</th><th>PM2</th></tr></thead><tbody><tr><td>Keep Alive</td><td>✔</td><td>✔</td></tr><tr><td>Coffeescript</td><td>✔</td><td></td></tr><tr><td>Log aggregation</td><td></td><td>✔</td></tr><tr><td>API</td><td></td><td>✔</td></tr><tr><td>Terminal monitoring</td><td></td><td>✔</td></tr><tr><td>Clustering</td><td></td><td>✔</td></tr><tr><td>JSON configuration</td><td></td><td>✔</td></tr></tbody></table>`,36)]))}const r=e(l,[["render",t]]),o=JSON.parse('{"path":"/nodejs/base/9au7a7hj/","title":"部署","lang":"zh-CN","frontmatter":{"title":"部署","createTime":"2025/08/25 11:34:23","permalink":"/nodejs/base/9au7a7hj/"},"readingTime":{"minutes":2.58,"words":774},"git":{"createdTime":1756099572000,"updatedTime":1756099572000,"contributors":[{"name":"wangzhije","username":"wangzhije","email":"1662285571@qq.com","commits":1,"avatar":"https://avatars.githubusercontent.com/wangzhije?v=4","url":"https://github.com/wangzhije"}]},"filePathRelative":"notes/2.nodejs/1.基础/部署.md","headers":[]}');export{r as comp,o as data};
