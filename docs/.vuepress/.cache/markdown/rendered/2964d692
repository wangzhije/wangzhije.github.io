{"content":"<h2 id=\"常用-package-包管理器\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#常用-package-包管理器\"><span>常用 package 包管理器</span></a></h2>\n<ul>\n<li>npm\n<ul>\n<li><a href=\"https://docs.npmjs.com/\" target=\"_blank\" rel=\"noopener noreferrer\">npm 官方文档</a></li>\n<li><a href=\"https://docs.npmjs.com/cli/v8/using-npm/scripts#life-cycle-operation-order\" target=\"_blank\" rel=\"noopener noreferrer\">npm 生命周期</a></li>\n</ul>\n</li>\n<li>cnpm</li>\n<li>yarn\n<ul>\n<li><a href=\"https://classic.yarnpkg.com/en/docs\" target=\"_blank\" rel=\"noopener noreferrer\">yarn 官方文档</a></li>\n</ul>\n</li>\n<li>pnpm\n<ul>\n<li><a href=\"https://www.pnpm.cn/\" target=\"_blank\" rel=\"noopener noreferrer\">pnpm 官方文档</a></li>\n</ul>\n</li>\n<li>Lerna 多包管理\n<ul>\n<li><a href=\"https://github.com/lerna/lerna\" target=\"_blank\" rel=\"noopener noreferrer\">Lerna 官方文档</a></li>\n</ul>\n</li>\n</ul>\n<h2 id=\"限制-package-管理器\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#限制-package-管理器\"><span>限制 package 管理器</span></a></h2>\n<p>包管理器太多，项目成员可能习惯使用的包管理器不同<br>\n规范化，则需要项目中限制使用<br>\n主要是为了避免项目依赖安装出错，保证项目能够正常运行</p>\n<blockquote>\n<p>原理【包管理器】执行 <code v-pre>install</code> 时调用 <code v-pre>preinstall</code> hooks<br>\n注意：【npm | yarn | cnpm | pnpm】 hooks 调用时机可能不同</p>\n</blockquote>\n<h3 id=\"only-allow-一句代码-统一项目包管理工具\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#only-allow-一句代码-统一项目包管理工具\"><span>only-allow：一句代码，统一项目包管理工具</span></a></h3>\n<div class=\"language-json line-numbers-mode\" data-highlighter=\"shiki\" data-ext=\"json\" style=\"--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212\"><pre class=\"shiki shiki-themes vitesse-light vitesse-dark vp-code\" v-pre=\"\"><code class=\"language-json\"><span class=\"line\"><span style=\"--shiki-light:#A0ADA0;--shiki-dark:#758575DD\">// package.json</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">{</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#99841877;--shiki-dark:#B8A96577\">  \"</span><span style=\"--shiki-light:#998418;--shiki-dark:#B8A965\">script</span><span style=\"--shiki-light:#99841877;--shiki-dark:#B8A96577\">\"</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\"> {</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#99841877;--shiki-dark:#B8A96577\">    \"</span><span style=\"--shiki-light:#998418;--shiki-dark:#B8A965\">preinstall</span><span style=\"--shiki-light:#99841877;--shiki-dark:#B8A96577\">\"</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\"> \"</span><span style=\"--shiki-light:#B56959;--shiki-dark:#C98A7D\">npx only-allow yarn</span><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">\"</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">  }</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">}</span></span></code></pre>\n<div class=\"line-numbers\" aria-hidden=\"true\" style=\"counter-reset:line-number 0\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><p>问题</p>\n<ol>\n<li>yarn 和 npm 的 preinstall hook 调用时机不同\n<ul>\n<li><code v-pre>npm</code> 只会在 <code v-pre>npm install</code> 安装整个项目依赖时调用</li>\n<li><code v-pre>npm install &lt;package&gt;</code>安装单个 package 时不调用；所以不会执行，也就无法限制使用 npm 安装</li>\n</ul>\n</li>\n</ol>\n<h3 id=\"自定义\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#自定义\"><span>自定义</span></a></h3>\n<p>Vue3 源码</p>\n<div class=\"language-json line-numbers-mode\" data-highlighter=\"shiki\" data-ext=\"json\" style=\"--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212\"><pre class=\"shiki shiki-themes vitesse-light vitesse-dark vp-code\" v-pre=\"\"><code class=\"language-json\"><span class=\"line\"><span style=\"--shiki-light:#A0ADA0;--shiki-dark:#758575DD\">// package.json</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">{</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#99841877;--shiki-dark:#B8A96577\">  \"</span><span style=\"--shiki-light:#998418;--shiki-dark:#B8A965\">script</span><span style=\"--shiki-light:#99841877;--shiki-dark:#B8A96577\">\"</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\"> {</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#99841877;--shiki-dark:#B8A96577\">    \"</span><span style=\"--shiki-light:#998418;--shiki-dark:#B8A965\">preinstall</span><span style=\"--shiki-light:#99841877;--shiki-dark:#B8A96577\">\"</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\"> \"</span><span style=\"--shiki-light:#B56959;--shiki-dark:#C98A7D\">node ./scripts/preinstall.js</span><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">\"</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">  }</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">}</span></span></code></pre>\n<div class=\"line-numbers\" aria-hidden=\"true\" style=\"counter-reset:line-number 0\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><div class=\"language-javascript line-numbers-mode\" data-highlighter=\"shiki\" data-ext=\"javascript\" style=\"--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212\"><pre class=\"shiki shiki-themes vitesse-light vitesse-dark vp-code\" v-pre=\"\"><code class=\"language-javascript\"><span class=\"line\"><span style=\"--shiki-light:#A0ADA0;--shiki-dark:#758575DD\">// preinstall.js</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">const</span><span style=\"--shiki-light:#B07D48;--shiki-dark:#BD976A\"> isPnpm</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\"> =</span><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\"> /</span><span style=\"--shiki-light:#AB5E3F;--shiki-dark:#C4704F\">pnpm</span><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">/</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#59873A;--shiki-dark:#80A665\">test</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#B07D48;--shiki-dark:#BD976A\">process</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#B07D48;--shiki-dark:#BD976A\">env</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#B07D48;--shiki-dark:#BD976A\">npm_execpath</span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\"> ||</span><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\"> ''</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">)</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#1E754F;--shiki-dark:#4D9375\">if</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\"> (</span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">!</span><span style=\"--shiki-light:#B07D48;--shiki-dark:#BD976A\">isPnpm</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">)</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\"> {</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#B07D48;--shiki-dark:#BD976A\">  console</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#59873A;--shiki-dark:#80A665\">warn</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">'</span><span style=\"--shiki-light:#B56959;--shiki-dark:#C98A7D\">当前包管理器不是 pnpm</span><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">'</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">);</span><span style=\"--shiki-light:#A0ADA0;--shiki-dark:#758575DD\"> // 命令行打印信息</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#B07D48;--shiki-dark:#BD976A\">  process</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#59873A;--shiki-dark:#80A665\">exit</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#2F798A;--shiki-dark:#4C9A91\">1</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">);</span><span style=\"--shiki-light:#A0ADA0;--shiki-dark:#758575DD\"> // 错误退出 node 命令行</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">}</span></span></code></pre>\n<div class=\"line-numbers\" aria-hidden=\"true\" style=\"counter-reset:line-number 0\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div>","env":{"base":"/blog/","filePath":"/Users/wangzhijie/Desktop/myspace/wangzhije.github.io/docs/notes/2.nodejs/2.包管理/README.md","filePathRelative":"notes/2.nodejs/2.包管理/README.md","frontmatter":{"title":"README","createTime":"2025/08/14 23:23:11","permalink":"/nodejs/package/start/"},"sfcBlocks":{"template":{"type":"template","content":"<template><h2 id=\"常用-package-包管理器\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#常用-package-包管理器\"><span>常用 package 包管理器</span></a></h2>\n<ul>\n<li>npm\n<ul>\n<li><a href=\"https://docs.npmjs.com/\" target=\"_blank\" rel=\"noopener noreferrer\">npm 官方文档</a></li>\n<li><a href=\"https://docs.npmjs.com/cli/v8/using-npm/scripts#life-cycle-operation-order\" target=\"_blank\" rel=\"noopener noreferrer\">npm 生命周期</a></li>\n</ul>\n</li>\n<li>cnpm</li>\n<li>yarn\n<ul>\n<li><a href=\"https://classic.yarnpkg.com/en/docs\" target=\"_blank\" rel=\"noopener noreferrer\">yarn 官方文档</a></li>\n</ul>\n</li>\n<li>pnpm\n<ul>\n<li><a href=\"https://www.pnpm.cn/\" target=\"_blank\" rel=\"noopener noreferrer\">pnpm 官方文档</a></li>\n</ul>\n</li>\n<li>Lerna 多包管理\n<ul>\n<li><a href=\"https://github.com/lerna/lerna\" target=\"_blank\" rel=\"noopener noreferrer\">Lerna 官方文档</a></li>\n</ul>\n</li>\n</ul>\n<h2 id=\"限制-package-管理器\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#限制-package-管理器\"><span>限制 package 管理器</span></a></h2>\n<p>包管理器太多，项目成员可能习惯使用的包管理器不同<br>\n规范化，则需要项目中限制使用<br>\n主要是为了避免项目依赖安装出错，保证项目能够正常运行</p>\n<blockquote>\n<p>原理【包管理器】执行 <code v-pre>install</code> 时调用 <code v-pre>preinstall</code> hooks<br>\n注意：【npm | yarn | cnpm | pnpm】 hooks 调用时机可能不同</p>\n</blockquote>\n<h3 id=\"only-allow-一句代码-统一项目包管理工具\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#only-allow-一句代码-统一项目包管理工具\"><span>only-allow：一句代码，统一项目包管理工具</span></a></h3>\n<div class=\"language-json line-numbers-mode\" data-highlighter=\"shiki\" data-ext=\"json\" style=\"--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212\"><pre class=\"shiki shiki-themes vitesse-light vitesse-dark vp-code\" v-pre=\"\"><code class=\"language-json\"><span class=\"line\"><span style=\"--shiki-light:#A0ADA0;--shiki-dark:#758575DD\">// package.json</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">{</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#99841877;--shiki-dark:#B8A96577\">  \"</span><span style=\"--shiki-light:#998418;--shiki-dark:#B8A965\">script</span><span style=\"--shiki-light:#99841877;--shiki-dark:#B8A96577\">\"</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\"> {</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#99841877;--shiki-dark:#B8A96577\">    \"</span><span style=\"--shiki-light:#998418;--shiki-dark:#B8A965\">preinstall</span><span style=\"--shiki-light:#99841877;--shiki-dark:#B8A96577\">\"</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\"> \"</span><span style=\"--shiki-light:#B56959;--shiki-dark:#C98A7D\">npx only-allow yarn</span><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">\"</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">  }</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">}</span></span></code></pre>\n<div class=\"line-numbers\" aria-hidden=\"true\" style=\"counter-reset:line-number 0\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><p>问题</p>\n<ol>\n<li>yarn 和 npm 的 preinstall hook 调用时机不同\n<ul>\n<li><code v-pre>npm</code> 只会在 <code v-pre>npm install</code> 安装整个项目依赖时调用</li>\n<li><code v-pre>npm install &lt;package&gt;</code>安装单个 package 时不调用；所以不会执行，也就无法限制使用 npm 安装</li>\n</ul>\n</li>\n</ol>\n<h3 id=\"自定义\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#自定义\"><span>自定义</span></a></h3>\n<p>Vue3 源码</p>\n<div class=\"language-json line-numbers-mode\" data-highlighter=\"shiki\" data-ext=\"json\" style=\"--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212\"><pre class=\"shiki shiki-themes vitesse-light vitesse-dark vp-code\" v-pre=\"\"><code class=\"language-json\"><span class=\"line\"><span style=\"--shiki-light:#A0ADA0;--shiki-dark:#758575DD\">// package.json</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">{</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#99841877;--shiki-dark:#B8A96577\">  \"</span><span style=\"--shiki-light:#998418;--shiki-dark:#B8A965\">script</span><span style=\"--shiki-light:#99841877;--shiki-dark:#B8A96577\">\"</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\"> {</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#99841877;--shiki-dark:#B8A96577\">    \"</span><span style=\"--shiki-light:#998418;--shiki-dark:#B8A965\">preinstall</span><span style=\"--shiki-light:#99841877;--shiki-dark:#B8A96577\">\"</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\"> \"</span><span style=\"--shiki-light:#B56959;--shiki-dark:#C98A7D\">node ./scripts/preinstall.js</span><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">\"</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">  }</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">}</span></span></code></pre>\n<div class=\"line-numbers\" aria-hidden=\"true\" style=\"counter-reset:line-number 0\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><div class=\"language-javascript line-numbers-mode\" data-highlighter=\"shiki\" data-ext=\"javascript\" style=\"--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212\"><pre class=\"shiki shiki-themes vitesse-light vitesse-dark vp-code\" v-pre=\"\"><code class=\"language-javascript\"><span class=\"line\"><span style=\"--shiki-light:#A0ADA0;--shiki-dark:#758575DD\">// preinstall.js</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">const</span><span style=\"--shiki-light:#B07D48;--shiki-dark:#BD976A\"> isPnpm</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\"> =</span><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\"> /</span><span style=\"--shiki-light:#AB5E3F;--shiki-dark:#C4704F\">pnpm</span><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">/</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#59873A;--shiki-dark:#80A665\">test</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#B07D48;--shiki-dark:#BD976A\">process</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#B07D48;--shiki-dark:#BD976A\">env</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#B07D48;--shiki-dark:#BD976A\">npm_execpath</span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\"> ||</span><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\"> ''</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">)</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#1E754F;--shiki-dark:#4D9375\">if</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\"> (</span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">!</span><span style=\"--shiki-light:#B07D48;--shiki-dark:#BD976A\">isPnpm</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">)</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\"> {</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#B07D48;--shiki-dark:#BD976A\">  console</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#59873A;--shiki-dark:#80A665\">warn</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">'</span><span style=\"--shiki-light:#B56959;--shiki-dark:#C98A7D\">当前包管理器不是 pnpm</span><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">'</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">);</span><span style=\"--shiki-light:#A0ADA0;--shiki-dark:#758575DD\"> // 命令行打印信息</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#B07D48;--shiki-dark:#BD976A\">  process</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#59873A;--shiki-dark:#80A665\">exit</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#2F798A;--shiki-dark:#4C9A91\">1</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">);</span><span style=\"--shiki-light:#A0ADA0;--shiki-dark:#758575DD\"> // 错误退出 node 命令行</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">}</span></span></code></pre>\n<div class=\"line-numbers\" aria-hidden=\"true\" style=\"counter-reset:line-number 0\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div></template>","contentStripped":"<h2 id=\"常用-package-包管理器\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#常用-package-包管理器\"><span>常用 package 包管理器</span></a></h2>\n<ul>\n<li>npm\n<ul>\n<li><a href=\"https://docs.npmjs.com/\" target=\"_blank\" rel=\"noopener noreferrer\">npm 官方文档</a></li>\n<li><a href=\"https://docs.npmjs.com/cli/v8/using-npm/scripts#life-cycle-operation-order\" target=\"_blank\" rel=\"noopener noreferrer\">npm 生命周期</a></li>\n</ul>\n</li>\n<li>cnpm</li>\n<li>yarn\n<ul>\n<li><a href=\"https://classic.yarnpkg.com/en/docs\" target=\"_blank\" rel=\"noopener noreferrer\">yarn 官方文档</a></li>\n</ul>\n</li>\n<li>pnpm\n<ul>\n<li><a href=\"https://www.pnpm.cn/\" target=\"_blank\" rel=\"noopener noreferrer\">pnpm 官方文档</a></li>\n</ul>\n</li>\n<li>Lerna 多包管理\n<ul>\n<li><a href=\"https://github.com/lerna/lerna\" target=\"_blank\" rel=\"noopener noreferrer\">Lerna 官方文档</a></li>\n</ul>\n</li>\n</ul>\n<h2 id=\"限制-package-管理器\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#限制-package-管理器\"><span>限制 package 管理器</span></a></h2>\n<p>包管理器太多，项目成员可能习惯使用的包管理器不同<br>\n规范化，则需要项目中限制使用<br>\n主要是为了避免项目依赖安装出错，保证项目能够正常运行</p>\n<blockquote>\n<p>原理【包管理器】执行 <code v-pre>install</code> 时调用 <code v-pre>preinstall</code> hooks<br>\n注意：【npm | yarn | cnpm | pnpm】 hooks 调用时机可能不同</p>\n</blockquote>\n<h3 id=\"only-allow-一句代码-统一项目包管理工具\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#only-allow-一句代码-统一项目包管理工具\"><span>only-allow：一句代码，统一项目包管理工具</span></a></h3>\n<div class=\"language-json line-numbers-mode\" data-highlighter=\"shiki\" data-ext=\"json\" style=\"--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212\"><pre class=\"shiki shiki-themes vitesse-light vitesse-dark vp-code\" v-pre=\"\"><code class=\"language-json\"><span class=\"line\"><span style=\"--shiki-light:#A0ADA0;--shiki-dark:#758575DD\">// package.json</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">{</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#99841877;--shiki-dark:#B8A96577\">  \"</span><span style=\"--shiki-light:#998418;--shiki-dark:#B8A965\">script</span><span style=\"--shiki-light:#99841877;--shiki-dark:#B8A96577\">\"</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\"> {</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#99841877;--shiki-dark:#B8A96577\">    \"</span><span style=\"--shiki-light:#998418;--shiki-dark:#B8A965\">preinstall</span><span style=\"--shiki-light:#99841877;--shiki-dark:#B8A96577\">\"</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\"> \"</span><span style=\"--shiki-light:#B56959;--shiki-dark:#C98A7D\">npx only-allow yarn</span><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">\"</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">  }</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">}</span></span></code></pre>\n<div class=\"line-numbers\" aria-hidden=\"true\" style=\"counter-reset:line-number 0\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><p>问题</p>\n<ol>\n<li>yarn 和 npm 的 preinstall hook 调用时机不同\n<ul>\n<li><code v-pre>npm</code> 只会在 <code v-pre>npm install</code> 安装整个项目依赖时调用</li>\n<li><code v-pre>npm install &lt;package&gt;</code>安装单个 package 时不调用；所以不会执行，也就无法限制使用 npm 安装</li>\n</ul>\n</li>\n</ol>\n<h3 id=\"自定义\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#自定义\"><span>自定义</span></a></h3>\n<p>Vue3 源码</p>\n<div class=\"language-json line-numbers-mode\" data-highlighter=\"shiki\" data-ext=\"json\" style=\"--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212\"><pre class=\"shiki shiki-themes vitesse-light vitesse-dark vp-code\" v-pre=\"\"><code class=\"language-json\"><span class=\"line\"><span style=\"--shiki-light:#A0ADA0;--shiki-dark:#758575DD\">// package.json</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">{</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#99841877;--shiki-dark:#B8A96577\">  \"</span><span style=\"--shiki-light:#998418;--shiki-dark:#B8A965\">script</span><span style=\"--shiki-light:#99841877;--shiki-dark:#B8A96577\">\"</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\"> {</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#99841877;--shiki-dark:#B8A96577\">    \"</span><span style=\"--shiki-light:#998418;--shiki-dark:#B8A965\">preinstall</span><span style=\"--shiki-light:#99841877;--shiki-dark:#B8A96577\">\"</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">:</span><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\"> \"</span><span style=\"--shiki-light:#B56959;--shiki-dark:#C98A7D\">node ./scripts/preinstall.js</span><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">\"</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">  }</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">}</span></span></code></pre>\n<div class=\"line-numbers\" aria-hidden=\"true\" style=\"counter-reset:line-number 0\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><div class=\"language-javascript line-numbers-mode\" data-highlighter=\"shiki\" data-ext=\"javascript\" style=\"--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212\"><pre class=\"shiki shiki-themes vitesse-light vitesse-dark vp-code\" v-pre=\"\"><code class=\"language-javascript\"><span class=\"line\"><span style=\"--shiki-light:#A0ADA0;--shiki-dark:#758575DD\">// preinstall.js</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">const</span><span style=\"--shiki-light:#B07D48;--shiki-dark:#BD976A\"> isPnpm</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\"> =</span><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\"> /</span><span style=\"--shiki-light:#AB5E3F;--shiki-dark:#C4704F\">pnpm</span><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">/</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#59873A;--shiki-dark:#80A665\">test</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#B07D48;--shiki-dark:#BD976A\">process</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#B07D48;--shiki-dark:#BD976A\">env</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#B07D48;--shiki-dark:#BD976A\">npm_execpath</span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\"> ||</span><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\"> ''</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">)</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#1E754F;--shiki-dark:#4D9375\">if</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\"> (</span><span style=\"--shiki-light:#AB5959;--shiki-dark:#CB7676\">!</span><span style=\"--shiki-light:#B07D48;--shiki-dark:#BD976A\">isPnpm</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">)</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\"> {</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#B07D48;--shiki-dark:#BD976A\">  console</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#59873A;--shiki-dark:#80A665\">warn</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">'</span><span style=\"--shiki-light:#B56959;--shiki-dark:#C98A7D\">当前包管理器不是 pnpm</span><span style=\"--shiki-light:#B5695977;--shiki-dark:#C98A7D77\">'</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">);</span><span style=\"--shiki-light:#A0ADA0;--shiki-dark:#758575DD\"> // 命令行打印信息</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#B07D48;--shiki-dark:#BD976A\">  process</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">.</span><span style=\"--shiki-light:#59873A;--shiki-dark:#80A665\">exit</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">(</span><span style=\"--shiki-light:#2F798A;--shiki-dark:#4C9A91\">1</span><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">);</span><span style=\"--shiki-light:#A0ADA0;--shiki-dark:#758575DD\"> // 错误退出 node 命令行</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#999999;--shiki-dark:#666666\">}</span></span></code></pre>\n<div class=\"line-numbers\" aria-hidden=\"true\" style=\"counter-reset:line-number 0\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div>","tagOpen":"<template>","tagClose":"</template>"},"script":null,"scriptSetup":null,"scripts":[],"styles":[],"customBlocks":[]},"content":"\n## 常用 package 包管理器\n\n- npm\n  - [npm 官方文档](https://docs.npmjs.com/)\n  - [npm 生命周期](https://docs.npmjs.com/cli/v8/using-npm/scripts#life-cycle-operation-order)\n- cnpm\n- yarn\n  - [yarn 官方文档](https://classic.yarnpkg.com/en/docs)\n- pnpm\n  - [pnpm 官方文档](https://www.pnpm.cn/)\n- Lerna 多包管理\n  - [Lerna 官方文档](https://github.com/lerna/lerna)\n\n## 限制 package 管理器\n\n包管理器太多，项目成员可能习惯使用的包管理器不同  \n规范化，则需要项目中限制使用  \n主要是为了避免项目依赖安装出错，保证项目能够正常运行\n\n> 原理【包管理器】执行 `install` 时调用 `preinstall` hooks  \n> 注意：【npm | yarn | cnpm | pnpm】 hooks 调用时机可能不同\n\n### only-allow：一句代码，统一项目包管理工具\n\n```json\n// package.json\n{\n  \"script\": {\n    \"preinstall\": \"npx only-allow yarn\"\n  }\n}\n```\n\n问题\n\n1. yarn 和 npm 的 preinstall hook 调用时机不同\n   - `npm` 只会在 `npm install` 安装整个项目依赖时调用\n   - `npm install <package>`安装单个 package 时不调用；所以不会执行，也就无法限制使用 npm 安装\n\n### 自定义\n\nVue3 源码\n\n```json\n// package.json\n{\n  \"script\": {\n    \"preinstall\": \"node ./scripts/preinstall.js\"\n  }\n}\n```\n\n```JavaScript\n// preinstall.js\nconst isPnpm = /pnpm/.test(process.env.npm_execpath || '')\nif (!isPnpm) {\n  console.warn('当前包管理器不是 pnpm'); // 命令行打印信息\n  process.exit(1); // 错误退出 node 命令行\n}\n```","excerpt":"","includedFiles":[],"tasklistId":0,"title":"","headers":[{"level":2,"title":"常用 package 包管理器","slug":"常用-package-包管理器","link":"#常用-package-包管理器","children":[]},{"level":2,"title":"限制 package 管理器","slug":"限制-package-管理器","link":"#限制-package-管理器","children":[{"level":3,"title":"only-allow：一句代码，统一项目包管理工具","slug":"only-allow-一句代码-统一项目包管理工具","link":"#only-allow-一句代码-统一项目包管理工具","children":[]},{"level":3,"title":"自定义","slug":"自定义","link":"#自定义","children":[]}]}]}}
